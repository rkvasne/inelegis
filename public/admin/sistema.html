<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log do Sistema - Inelegis Admin</title>
    <link rel="stylesheet" href="../styles/admin.css">
    <link rel="icon" href="../favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 3rem;">
                <img src="../favicon.ico" alt="Inelegis" width="40" style="vertical-align: middle;">
                <span
                    style="font-size: 1.25rem; font-weight: 700; margin-left: 0.5rem; color: var(--text-main);">Auditoria</span>
            </div>

            <nav style="flex: 1;">
                <div
                    style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1rem; margin-bottom: 1rem;">
                    Menu</div>
                <a href="/admin/dashboard.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    üìâ Vis√£o Geral
                </a>
                <a href="/admin/historico.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    üìã Hist√≥rico
                </a>
                <a href="/admin/analytics.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    üìä Analytics
                </a>
                <a href="/admin/sistema.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem; background: var(--glass);">
                    ‚öôÔ∏è Sistema
                </a>
                <a href="/" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    üè† Voltar ao Site
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem;">
                <button id="logoutBtn" class="btn btn-danger-outline" style="width: 100%;">
                    Encerrar Sess√£o
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="margin: 0; font-size: 1.75rem; letter-spacing: -0.025em; font-weight: 800;">Log do
                        Sistema</h1>
                    <p style="color: var(--text-muted); margin: 0.25rem 0 0 0;">Relat√≥rio de pulso e sa√∫de do
                        ecossistema Inelegis</p>
                </div>
                <div class="glass-panel"
                    style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
                    <div class="pulse-indicator"></div>
                    <span id="uptimeStatus" style="font-size: 0.875rem;">Keepalive: Verificando...</span>
                </div>
            </header>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Sinais de Vida (Heartbeats)</div>
                    <div id="statTotal" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">--</div>
                </div>
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Lat√™ncia Supabase (ms)</div>
                    <div id="statLatency"
                        style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem; color: var(--success);">--</div>
                </div>
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Disponibilidade (24h)</div>
                    <div id="statUptime"
                        style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem; color: var(--primary);">100%</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-panel"
                style="padding: 1.5rem; margin-bottom: 1.5rem; display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" class="form-control" style="min-width: 160px;">
                        <option value="">Todos</option>
                        <option value="ok">Ok</option>
                        <option value="error">Erro</option>
                    </select>
                </div>
                <div style="flex: 1;"></div>
                <button id="refreshBtn" class="btn btn-secondary" style="white-space: nowrap;">
                    üîÑ Atualizar Logs
                </button>
            </div>

            <!-- Table -->
            <div class="glass-panel" style="padding: 0; overflow: hidden;">
                <table class="data-table" id="systemTable">
                    <thead>
                        <tr>
                            <th>Hor√°rio</th>
                            <th>Status</th>
                            <th>Origem (Source)</th>
                            <th>Lat√™ncia</th>
                            <th>Informa√ß√µes Adicionais</th>
                        </tr>
                    </thead>
                    <tbody id="systemTableBody">
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                Carregando dados do sistema...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="paginationInfo"
                style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--text-muted);"></div>
        </main>
    </div>

    <!-- Config -->
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/admin/supabase-admin-init.js"></script>

    <script type="module">
        import { authService } from '../assets/js/admin/auth-service.js?v=0.3.24';

        const SystemAdmin = (() => {
            let allData = [];

            async function init() {
                bindEvents();
                await loadData();
                await loadUptime();
            }

            function bindEvents() {
                document.getElementById('refreshBtn')?.addEventListener('click', loadData);
                document.getElementById('filterStatus')?.addEventListener('change', renderTable);
            }

            async function loadData() {
                try {
                    const { data, error } = await window.supabase
                        .from('keepalive_events')
                        .select('*')
                        .order('ping_at', { ascending: false })
                        .limit(200);

                    if (error) throw error;

                    allData = data || [];

                    // Se estiver vazio, tenta pegar o status √∫nico do keepalive (singular)
                    if (allData.length === 0) {
                        const { data: statusData } = await window.supabase.from("keepalive").select("*").limit(1);
                        if (statusData && statusData.length > 0) {
                            allData = [{
                                ping_at: statusData[0].last_ping_at,
                                status: 'ok',
                                source: 'db-pulse',
                                latency_ms: 0,
                                error: 'Tabela de eventos vazia, exibindo √∫ltimo pulso do banco.'
                            }];
                        }
                    }

                    renderStats();
                    renderTable();
                } catch (err) {
                    console.error('Erro ao carregar sistema:', err);
                    document.getElementById('systemTableBody').innerHTML =
                        `<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--danger);">Erro ao carregar dados: ${err.message}</td></tr>`;
                }
            }

            async function loadUptime() {
                const { data } = await window.supabase.from("keepalive").select("*").limit(1);
                const statusEl = document.getElementById("uptimeStatus");
                if (data && data.length > 0) {
                    const lastPing = new Date(data[0].last_ping_at);
                    const now = new Date();
                    const diffMin = Math.round((now - lastPing) / (1000 * 60));
                    statusEl.textContent = `Keepalive: ${diffMin < 10 ? 'Online' : 'Aten√ß√£o'} (${diffMin}m)`;
                } else {
                    statusEl.textContent = `Keepalive: Sem registros`;
                }
            }

            function renderStats() {
                const total = allData.length;
                const times = allData.map(r => r.latency_ms).filter(t => t > 0);
                const avgLatency = times.length > 0 ? Math.round(times.reduce((a, b) => a + b, 0) / times.length) : '--';

                document.getElementById('statTotal').textContent = total;
                document.getElementById('statLatency').textContent = avgLatency;
            }

            function renderTable() {
                const tbody = document.getElementById('systemTableBody');
                const info = document.getElementById('paginationInfo');
                const filter = document.getElementById('filterStatus').value;

                let filtered = allData;
                if (filter) {
                    filtered = allData.filter(r => r.status === filter);
                }

                if (!filtered.length) {
                    tbody.innerHTML = `<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">Nenhum sinal detectado.</td></tr>`;
                    if (info) info.textContent = `0 sinais registrados`;
                    return;
                }

                if (info) info.textContent = `Exibindo ${filtered.length} sinais (Logs das √∫ltimas 24h-48h)`;

                const fragment = document.createDocumentFragment();
                filtered.forEach(entry => {
                    const row = document.createElement('tr');

                    const tdTime = document.createElement('td');
                    tdTime.style.color = 'var(--text-muted)';
                    tdTime.textContent = new Date(entry.ping_at).toLocaleString('pt-BR');

                    const tdStatus = document.createElement('td');
                    const badge = document.createElement('span');
                    badge.className = entry.status === 'ok' ? 'badge badge-success' : 'badge badge-danger';
                    badge.textContent = entry.status === 'ok' ? 'ONLINE' : 'ERRO';
                    tdStatus.appendChild(badge);

                    const tdSource = document.createElement('td');
                    tdSource.textContent = entry.source || 'service-worker';

                    const tdLat = document.createElement('td');
                    tdLat.innerHTML = entry.latency_ms ? `<code>${entry.latency_ms}ms</code>` : '‚Äî';

                    const tdInfo = document.createElement('td');
                    tdInfo.style.fontSize = '0.75rem';
                    tdInfo.style.color = 'var(--text-muted)';
                    tdInfo.textContent = entry.error || (entry.metadata ? JSON.stringify(entry.metadata) : 'Batimento card√≠aco regular');

                    row.appendChild(tdTime);
                    row.appendChild(tdStatus);
                    row.appendChild(tdSource);
                    row.appendChild(tdLat);
                    row.appendChild(tdInfo);
                    fragment.appendChild(row);
                });

                tbody.innerHTML = '';
                tbody.appendChild(fragment);
            }

            return { init };
        })();

        (async () => {
            if (!(await authService.isAuthenticated())) {
                window.location.href = '/admin/index.html';
                return;
            }

            document.getElementById('logoutBtn')?.addEventListener('click', async () => {
                if (confirm('Deseja encerrar a sess√£o?')) await authService.logout();
            });

            await SystemAdmin.init();
        })();
    </script>
</body>

</html>