<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico - Inelegis Admin</title>
    <link rel="stylesheet" href="../styles/admin.css">
    <link rel="icon" href="../favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 3rem;">
                <img src="../favicon.ico" alt="Inelegis" width="40" style="vertical-align: middle;">
                <span
                    style="font-size: 1.25rem; font-weight: 700; margin-left: 0.5rem; color: var(--text-main);">Auditoria</span>
            </div>

            <nav style="flex: 1;">
                <div
                    style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1rem; margin-bottom: 1rem;">
                    Menu</div>
                <a href="/admin/dashboard.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start;">
                    üìâ Vis√£o Geral
                </a>
                <a href="/admin/historico.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem; background: var(--glass);">
                    üìã Hist√≥rico
                </a>
                <a href="/admin/analytics.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    üìä Analytics
                </a>
                <a href="/admin/sistema.html" class="btn btn-ghost"
                    style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    ‚öôÔ∏è Sistema
                </a>
                <a href="/" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; margin-top: 0.5rem;">
                    üè† Voltar ao Site
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem;">
                <button id="logoutBtn" class="btn btn-danger-outline" style="width: 100%;">
                    Encerrar Sess√£o
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="margin: 0; font-size: 1.75rem; letter-spacing: -0.025em; font-weight: 800;">Hist√≥rico de
                        Consultas</h1>
                    <p style="color: var(--text-muted); margin: 0.25rem 0 0 0;">Auditoria completa de veredictos gerados
                    </p>
                </div>
                <div class="glass-panel"
                    style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.75rem;">
                    <div class="pulse-indicator"></div>
                    <span id="uptimeStatus" style="font-size: 0.875rem;">Keepalive: Ativo</span>
                </div>
            </header>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Total de Consultas</div>
                    <div id="statTotal" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">--</div>
                </div>
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Ineleg√≠veis</div>
                    <div id="statInelegiveis"
                        style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem; color: var(--danger);">--</div>
                </div>
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Eleg√≠veis</div>
                    <div id="statElegiveis"
                        style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem; color: var(--success);">--</div>
                </div>
                <div class="stat-card glass-panel">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">√öltima Consulta</div>
                    <div id="statUltima" style="font-size: 1rem; font-weight: 600; margin-top: 1rem;">--</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-panel"
                style="padding: 1.5rem; margin-bottom: 1.5rem; display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                <div class="filter-group">
                    <label>Lei</label>
                    <select id="filterLei" class="form-control" style="min-width: 160px;">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Veredicto</label>
                    <select id="filterVeredicto" class="form-control" style="min-width: 160px;">
                        <option value="">Todos</option>
                        <option value="elegivel">Eleg√≠vel</option>
                        <option value="inelegivel">Ineleg√≠vel</option>
                    </select>
                </div>
                <div class="filter-group" style="flex: 1; min-width: 250px;">
                    <label>Busca Livre</label>
                    <input id="filterSearch" type="search" class="form-control"
                        placeholder="Buscar por artigo ou crime...">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="refreshBtn" class="btn btn-secondary" style="white-space: nowrap;">
                        üîÑ Atualizar
                    </button>
                    <button id="exportBtn" class="btn btn-ghost" style="white-space: nowrap;">
                        üì• Exportar .txt
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="glass-panel" style="padding: 0; overflow: hidden;">
                <table class="data-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Hor√°rio</th>
                            <th>Dispositivo Legal</th>
                            <th>Veredicto</th>
                            <th>A√ß√£o/Causa</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                Carregando hist√≥rico...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="paginationInfo"
                style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: var(--text-muted);"></div>
        </main>
    </div>

    <!-- Config -->
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/admin/supabase-admin-init.js"></script>

    <script type="module">
        import { authService } from '../assets/js/admin/auth-service.js?v=0.3.12';
        import { keepaliveService } from '../assets/js/services/keepalive-service.js';

        const HistoryAdmin = (() => {
            let allData = [];
            let filteredData = [];

            async function init() {
                keepaliveService.init();
                bindEvents();
                await loadData();
                await loadUptime();
            }

            function bindEvents() {
                document.getElementById('refreshBtn')?.addEventListener('click', loadData);
                document.getElementById('exportBtn')?.addEventListener('click', exportTxt);
                document.getElementById('filterLei')?.addEventListener('change', applyFilters);
                document.getElementById('filterVeredicto')?.addEventListener('change', applyFilters);
                document.getElementById('filterSearch')?.addEventListener('input', applyFilters);
            }

            async function loadData() {
                try {
                    const { data, error } = await window.supabase
                        .from('historico_consultas')
                        .select('*')
                        .order('timestamp', { ascending: false });

                    if (error) throw error;

                    allData = data || [];
                    filteredData = [...allData];

                    renderStats();
                    populateLeiFilter();
                    renderTable();
                } catch (err) {
                    console.error('Erro ao carregar hist√≥rico:', err);
                    document.getElementById('historyTableBody').innerHTML =
                        `<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--danger);">Erro ao carregar dados: ${err.message}</td></tr>`;
                }
            }

            async function loadUptime() {
                const { data } = await window.supabase.from("keepalive").select("*").limit(1);
                const statusEl = document.getElementById("uptimeStatus");
                if (data && data.length > 0) {
                    const lastPing = new Date(data[0].last_ping_at);
                    const now = new Date();
                    const diffMin = Math.round((now - lastPing) / (1000 * 60));
                    statusEl.textContent = `Keepalive: ${diffMin < 10 ? 'Online' : 'Aten√ß√£o'} (${diffMin}m)`;
                }
            }

            function renderStats() {
                const total = allData.length;
                const inelegiveis = allData.filter(r => r.resultado === 'inelegivel').length;
                const elegiveis = allData.filter(r => r.resultado === 'elegivel').length;
                const ultima = allData[0]?.timestamp
                    ? new Date(allData[0].timestamp).toLocaleString('pt-BR')
                    : 'Sem registros';

                document.getElementById('statTotal').textContent = total;
                document.getElementById('statInelegiveis').textContent = inelegiveis;
                document.getElementById('statElegiveis').textContent = elegiveis;
                document.getElementById('statUltima').textContent = ultima;
            }

            function populateLeiFilter() {
                const select = document.getElementById('filterLei');
                if (!select) return;
                const leis = [...new Set(allData.map(r => r.lei).filter(Boolean))].sort();
                select.innerHTML = '<option value="">Todas</option>';
                leis.forEach(lei => {
                    const opt = document.createElement('option');
                    opt.value = lei;
                    opt.textContent = lei;
                    select.appendChild(opt);
                });
            }

            function applyFilters() {
                const lei = document.getElementById('filterLei')?.value || '';
                const veredicto = document.getElementById('filterVeredicto')?.value || '';
                const search = (document.getElementById('filterSearch')?.value || '').toLowerCase().trim();

                filteredData = allData.filter(r => {
                    if (lei && r.lei !== lei) return false;
                    if (veredicto && r.resultado !== veredicto) return false;
                    if (search) {
                        const searchable = [r.artigo, r.tipo_crime, r.observacoes, r.lei].filter(Boolean).join(' ').toLowerCase();
                        if (!searchable.includes(search)) return false;
                    }
                    return true;
                });
                renderTable();
            }

            function renderTable() {
                const tbody = document.getElementById('historyTableBody');
                const info = document.getElementById('paginationInfo');
                if (!filteredData.length) {
                    tbody.innerHTML = `<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">Nenhum registro encontrado.</td></tr>`;
                    if (info) info.textContent = `0 de ${allData.length} registros`;
                    return;
                }
                if (info) info.textContent = `Exibindo ${filteredData.length} de ${allData.length} registros`;

                const fragment = document.createDocumentFragment();
                filteredData.forEach(entry => {
                    const row = document.createElement('tr');

                    const tdTime = document.createElement('td');
                    tdTime.style.color = 'var(--text-muted)';
                    tdTime.textContent = entry.timestamp ? new Date(entry.timestamp).toLocaleString('pt-BR') : 'N/A';

                    const tdLei = document.createElement('td');
                    tdLei.innerHTML = `<small style="display:block;color:var(--text-muted)">${entry.lei || 'N/A'}</small><strong>Art. ${entry.artigo || 'N/A'}</strong>`;

                    const tdVeredicto = document.createElement('td');
                    const badge = document.createElement('span');
                    const isInelegivel = entry.resultado === 'inelegivel';
                    badge.className = isInelegivel ? 'badge badge-danger' : 'badge badge-success';
                    badge.textContent = isInelegivel ? 'INELEG√çVEL' : 'ELEG√çVEL';
                    tdVeredicto.appendChild(badge);

                    const tdCrime = document.createElement('td');
                    tdCrime.textContent = entry.tipo_crime || 'N/A';

                    const tdDetails = document.createElement('td');
                    if (entry.observacoes || entry.motivo_detalhado) {
                        const detailBtn = document.createElement('button');
                        detailBtn.className = 'btn btn-secondary';
                        detailBtn.textContent = 'üìÑ Ver Fundamenta√ß√£o';
                        detailBtn.onclick = () => alert(`Fundamenta√ß√£o:\n\n${entry.motivo_detalhado || entry.observacoes}`);
                        tdDetails.appendChild(detailBtn);
                    } else {
                        tdDetails.innerHTML = '<span style="color:var(--text-muted)">‚Äî</span>';
                    }

                    row.appendChild(tdTime);
                    row.appendChild(tdLei);
                    row.appendChild(tdVeredicto);
                    row.appendChild(tdCrime);
                    row.appendChild(tdDetails);
                    fragment.appendChild(row);
                });
                tbody.innerHTML = '';
                tbody.appendChild(fragment);
            }

            function exportTxt() {
                if (!filteredData.length) return alert('Nenhum dado para exportar.');
                let content = "HIST√ìRICO DE CONSULTAS - INELEGIS\n" + "=".repeat(40) + "\n\n";
                filteredData.forEach(r => {
                    content += `[${new Date(r.timestamp).toLocaleString()}] ${r.resultado.toUpperCase()}\n`;
                    content += `Lei: ${r.lei} | Artigo: ${r.artigo}\n`;
                    content += `Crime: ${r.tipo_crime}\n`;
                    content += `Fundamenta√ß√£o: ${r.motivo_detalhado || r.observacoes || 'N/A'}\n`;
                    content += "-".repeat(40) + "\n";
                });
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `historico_inelegis_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            return { init };
        })();

        (async () => {
            if (!(await authService.isAuthenticated())) {
                window.location.href = '/admin/index.html';
                return;
            }
            document.getElementById('logoutBtn')?.addEventListener('click', async () => {
                if (confirm('Deseja encerrar a sess√£o?')) await authService.logout();
            });
            await HistoryAdmin.init();
        })();
    </script>
</body>

</html>