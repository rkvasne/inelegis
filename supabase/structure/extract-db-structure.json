{
  "analytics_events": {
    "nome": "analytics_events",
    "tipo": "BASE TABLE",
    "colunas": [
      {
        "nome": "id",
        "posicao": 1,
        "tipo": "bigint",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "nextval('analytics_events_id_seq'::regclass)"
      },
      {
        "nome": "type",
        "posicao": 2,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "user_id",
        "posicao": 3,
        "tipo": "character varying",
        "tamanhoMax": 100,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "timestamp",
        "posicao": 4,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": "now()"
      },
      {
        "nome": "lei",
        "posicao": 5,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "artigo",
        "posicao": 6,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "resultado",
        "posicao": 7,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "tem_excecao",
        "posicao": 8,
        "tipo": "boolean",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "tempo_resposta",
        "posicao": 9,
        "tipo": "integer",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "browser",
        "posicao": 10,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "version",
        "posicao": 11,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "data",
        "posicao": 12,
        "tipo": "jsonb",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      }
    ],
    "constraints": [
      {
        "nome": "analytics_events_pkey",
        "tipo": "PRIMARY KEY",
        "coluna": "id",
        "tabelaReferenciada": "",
        "colunaReferenciada": ""
      }
    ],
    "indexes": [
      {
        "nome": "analytics_events_pkey",
        "definicao": "CREATE UNIQUE INDEX analytics_events_pkey ON public.analytics_events USING btree (id)"
      },
      {
        "nome": "idx_analytics_lei",
        "definicao": "CREATE INDEX idx_analytics_lei ON public.analytics_events USING btree (lei) WHERE (lei IS NOT NULL)"
      },
      {
        "nome": "idx_analytics_timestamp",
        "definicao": "CREATE INDEX idx_analytics_timestamp ON public.analytics_events USING btree (\"timestamp\" DESC)"
      },
      {
        "nome": "idx_analytics_type",
        "definicao": "CREATE INDEX idx_analytics_type ON public.analytics_events USING btree (type)"
      },
      {
        "nome": "idx_analytics_user",
        "definicao": "CREATE INDEX idx_analytics_user ON public.analytics_events USING btree (user_id)"
      }
    ],
    "triggers": [],
    "estatisticas": {
      "totalColunas": 12,
      "totalConstraints": 1,
      "totalIndexes": 5,
      "totalTriggers": 0
    }
  },
  "crimes_inelegibilidade": {
    "nome": "crimes_inelegibilidade",
    "tipo": "BASE TABLE",
    "colunas": [
      {
        "nome": "id",
        "posicao": 1,
        "tipo": "integer",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "nextval('crimes_inelegibilidade_id_seq'::regclass)"
      },
      {
        "nome": "codigo",
        "posicao": 2,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "lei",
        "posicao": 3,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "artigo",
        "posicao": 4,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "paragrafo",
        "posicao": 5,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "inciso",
        "posicao": 6,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "alinea",
        "posicao": 7,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "eh_excecao",
        "posicao": 8,
        "tipo": "boolean",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": "false"
      },
      {
        "nome": "tipo_crime",
        "posicao": 9,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "item_alinea_e",
        "posicao": 10,
        "tipo": "character varying",
        "tamanhoMax": 10,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "observacoes",
        "posicao": 11,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "created_at",
        "posicao": 12,
        "tipo": "timestamp without time zone",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": "now()"
      },
      {
        "nome": "updated_at",
        "posicao": 13,
        "tipo": "timestamp without time zone",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": "now()"
      }
    ],
    "constraints": [
      {
        "nome": "crimes_inelegibilidade_pkey",
        "tipo": "PRIMARY KEY",
        "coluna": "id",
        "tabelaReferenciada": "",
        "colunaReferenciada": ""
      }
    ],
    "indexes": [
      {
        "nome": "crimes_inelegibilidade_pkey",
        "definicao": "CREATE UNIQUE INDEX crimes_inelegibilidade_pkey ON public.crimes_inelegibilidade USING btree (id)"
      },
      {
        "nome": "idx_crimes_artigo",
        "definicao": "CREATE INDEX idx_crimes_artigo ON public.crimes_inelegibilidade USING btree (artigo)"
      },
      {
        "nome": "idx_crimes_codigo",
        "definicao": "CREATE INDEX idx_crimes_codigo ON public.crimes_inelegibilidade USING btree (codigo)"
      },
      {
        "nome": "idx_crimes_codigo_artigo",
        "definicao": "CREATE INDEX idx_crimes_codigo_artigo ON public.crimes_inelegibilidade USING btree (codigo, artigo)"
      },
      {
        "nome": "idx_crimes_excecao",
        "definicao": "CREATE INDEX idx_crimes_excecao ON public.crimes_inelegibilidade USING btree (eh_excecao)"
      }
    ],
    "triggers": [],
    "estatisticas": {
      "totalColunas": 13,
      "totalConstraints": 1,
      "totalIndexes": 5,
      "totalTriggers": 0
    }
  },
  "historico_consultas": {
    "nome": "historico_consultas",
    "tipo": "BASE TABLE",
    "colunas": [
      {
        "nome": "id",
        "posicao": 1,
        "tipo": "bigint",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "nextval('historico_consultas_id_seq'::regclass)"
      },
      {
        "nome": "user_id",
        "posicao": 2,
        "tipo": "character varying",
        "tamanhoMax": 100,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "lei",
        "posicao": 3,
        "tipo": "character varying",
        "tamanhoMax": 50,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "artigo",
        "posicao": 4,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "resultado",
        "posicao": 5,
        "tipo": "character varying",
        "tamanhoMax": 20,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "timestamp",
        "posicao": 6,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": "now()"
      },
      {
        "nome": "tipo_crime",
        "posicao": 7,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "observacoes",
        "posicao": 8,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      }
    ],
    "constraints": [
      {
        "nome": "historico_consultas_pkey",
        "tipo": "PRIMARY KEY",
        "coluna": "id",
        "tabelaReferenciada": "",
        "colunaReferenciada": ""
      }
    ],
    "indexes": [
      {
        "nome": "historico_consultas_pkey",
        "definicao": "CREATE UNIQUE INDEX historico_consultas_pkey ON public.historico_consultas USING btree (id)"
      },
      {
        "nome": "idx_historico_timestamp",
        "definicao": "CREATE INDEX idx_historico_timestamp ON public.historico_consultas USING btree (\"timestamp\" DESC)"
      },
      {
        "nome": "idx_historico_user_id",
        "definicao": "CREATE INDEX idx_historico_user_id ON public.historico_consultas USING btree (user_id)"
      },
      {
        "nome": "idx_historico_user_timestamp",
        "definicao": "CREATE INDEX idx_historico_user_timestamp ON public.historico_consultas USING btree (user_id, \"timestamp\" DESC)"
      }
    ],
    "triggers": [],
    "estatisticas": {
      "totalColunas": 8,
      "totalConstraints": 1,
      "totalIndexes": 4,
      "totalTriggers": 0
    }
  },
  "keepalive": {
    "nome": "keepalive",
    "tipo": "BASE TABLE",
    "colunas": [
      {
        "nome": "id",
        "posicao": 1,
        "tipo": "bigint",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "1"
      },
      {
        "nome": "project_slug",
        "posicao": 2,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'inelegis'::text"
      },
      {
        "nome": "environment",
        "posicao": 3,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'prod'::text"
      },
      {
        "nome": "region",
        "posicao": 4,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "source",
        "posicao": 5,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'unknown'::text"
      },
      {
        "nome": "last_ping_at",
        "posicao": 6,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "now()"
      },
      {
        "nome": "last_success_at",
        "posicao": 7,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "now()"
      },
      {
        "nome": "last_error",
        "posicao": 8,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "latency_ms",
        "posicao": 9,
        "tipo": "integer",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "schema_version",
        "posicao": 10,
        "tipo": "integer",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "1"
      },
      {
        "nome": "metadata",
        "posicao": 11,
        "tipo": "jsonb",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'{}'::jsonb"
      }
    ],
    "constraints": [
      {
        "nome": "keepalive_pkey",
        "tipo": "PRIMARY KEY",
        "coluna": "id",
        "tabelaReferenciada": "",
        "colunaReferenciada": ""
      }
    ],
    "indexes": [
      {
        "nome": "keepalive_pkey",
        "definicao": "CREATE UNIQUE INDEX keepalive_pkey ON public.keepalive USING btree (id)"
      }
    ],
    "triggers": [],
    "estatisticas": {
      "totalColunas": 11,
      "totalConstraints": 1,
      "totalIndexes": 1,
      "totalTriggers": 0
    }
  },
  "keepalive_events": {
    "nome": "keepalive_events",
    "tipo": "BASE TABLE",
    "colunas": [
      {
        "nome": "id",
        "posicao": 1,
        "tipo": "bigint",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "nextval('keepalive_events_id_seq'::regclass)"
      },
      {
        "nome": "project_slug",
        "posicao": 2,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "environment",
        "posicao": 3,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "region",
        "posicao": 4,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "source",
        "posicao": 5,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": null
      },
      {
        "nome": "ping_at",
        "posicao": 6,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "now()"
      },
      {
        "nome": "status",
        "posicao": 7,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'ok'::text"
      },
      {
        "nome": "latency_ms",
        "posicao": 8,
        "tipo": "integer",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "error",
        "posicao": 9,
        "tipo": "text",
        "tamanhoMax": null,
        "permiteNulo": "YES",
        "valorPadrao": null
      },
      {
        "nome": "metadata",
        "posicao": 10,
        "tipo": "jsonb",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "'{}'::jsonb"
      },
      {
        "nome": "created_at",
        "posicao": 11,
        "tipo": "timestamp with time zone",
        "tamanhoMax": null,
        "permiteNulo": "NO",
        "valorPadrao": "now()"
      }
    ],
    "constraints": [
      {
        "nome": "keepalive_events_pkey",
        "tipo": "PRIMARY KEY",
        "coluna": "id",
        "tabelaReferenciada": "",
        "colunaReferenciada": ""
      }
    ],
    "indexes": [
      {
        "nome": "idx_keepalive_events_ping_at",
        "definicao": "CREATE INDEX idx_keepalive_events_ping_at ON public.keepalive_events USING btree (ping_at DESC)"
      },
      {
        "nome": "idx_keepalive_events_project_env",
        "definicao": "CREATE INDEX idx_keepalive_events_project_env ON public.keepalive_events USING btree (project_slug, environment)"
      },
      {
        "nome": "keepalive_events_pkey",
        "definicao": "CREATE UNIQUE INDEX keepalive_events_pkey ON public.keepalive_events USING btree (id)"
      }
    ],
    "triggers": [],
    "estatisticas": {
      "totalColunas": 11,
      "totalConstraints": 1,
      "totalIndexes": 3,
      "totalTriggers": 0
    }
  },
  "_funcoes": {
    "nome": "funcoes",
    "tipo": "FUNCTIONS",
    "funcoes": [
      {
        "nome": "add_to_history",
        "tipo": "f",
        "retorno": "historico_consultas",
        "definicao": "CREATE OR REPLACE FUNCTION public.add_to_history(p_user_id character varying, p_lei character varying, p_artigo character varying, p_resultado character varying, p_tipo_crime text DEFAULT NULL::text, p_observacoes text DEFAULT NULL::text)\n RETURNS historico_consultas\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_new_record historico_consultas;\r\nBEGIN\r\n  INSERT INTO historico_consultas (user_id, lei, artigo, resultado, tipo_crime, observacoes)\r\n  VALUES (p_user_id, p_lei, p_artigo, p_resultado, p_tipo_crime, p_observacoes)\r\n  RETURNING * INTO v_new_record;\r\n  \r\n  RETURN v_new_record;\r\nEND;\r\n$function$\n"
      },
      {
        "nome": "get_dashboard_stats",
        "tipo": "f",
        "retorno": "TABLE(total_searches bigint, total_users bigint, total_errors bigint, inelegiveis bigint, elegiveis bigint)",
        "definicao": "CREATE OR REPLACE FUNCTION public.get_dashboard_stats()\n RETURNS TABLE(total_searches bigint, total_users bigint, total_errors bigint, inelegiveis bigint, elegiveis bigint)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    COUNT(*) FILTER (WHERE type = 'search')::BIGINT as total_searches,\r\n    COUNT(DISTINCT user_id)::BIGINT as total_users,\r\n    COUNT(*) FILTER (WHERE type = 'error')::BIGINT as total_errors,\r\n    COUNT(*) FILTER (WHERE resultado = 'inelegivel')::BIGINT as inelegiveis,\r\n    COUNT(*) FILTER (WHERE resultado = 'elegivel')::BIGINT as elegiveis\r\n  FROM analytics_events;\r\nEND;\r\n$function$\n"
      },
      {
        "nome": "get_user_history",
        "tipo": "f",
        "retorno": "SETOF historico_consultas",
        "definicao": "CREATE OR REPLACE FUNCTION public.get_user_history(p_user_id character varying, p_limit integer DEFAULT 50)\n RETURNS SETOF historico_consultas\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT *\r\n  FROM historico_consultas\r\n  WHERE user_id = p_user_id\r\n  ORDER BY timestamp DESC\r\n  LIMIT p_limit;\r\nEND;\r\n$function$\n"
      },
      {
        "nome": "get_user_stats",
        "tipo": "f",
        "retorno": "TABLE(total bigint, inelegiveis bigint, elegiveis bigint, nao_consta bigint, primeira_consulta timestamp with time zone, ultima_consulta timestamp with time zone)",
        "definicao": "CREATE OR REPLACE FUNCTION public.get_user_stats(p_user_id character varying)\n RETURNS TABLE(total bigint, inelegiveis bigint, elegiveis bigint, nao_consta bigint, primeira_consulta timestamp with time zone, ultima_consulta timestamp with time zone)\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nBEGIN\r\n  RETURN QUERY\r\n  SELECT \r\n    COUNT(*)::BIGINT as total,\r\n    COUNT(*) FILTER (WHERE resultado = 'inelegivel')::BIGINT as inelegiveis,\r\n    COUNT(*) FILTER (WHERE resultado = 'elegivel')::BIGINT as elegiveis,\r\n    COUNT(*) FILTER (WHERE resultado = 'nao_consta')::BIGINT as nao_consta,\r\n    MIN(timestamp) as primeira_consulta,\r\n    MAX(timestamp) as ultima_consulta\r\n  FROM historico_consultas\r\n  WHERE user_id = p_user_id;\r\nEND;\r\n$function$\n"
      },
      {
        "nome": "insert_analytics_event",
        "tipo": "f",
        "retorno": "analytics_events",
        "definicao": "CREATE OR REPLACE FUNCTION public.insert_analytics_event(p_type character varying, p_user_id character varying, p_lei character varying DEFAULT NULL::character varying, p_artigo character varying DEFAULT NULL::character varying, p_resultado character varying DEFAULT NULL::character varying, p_tem_excecao boolean DEFAULT NULL::boolean, p_tempo_resposta integer DEFAULT NULL::integer, p_browser text DEFAULT NULL::text, p_version character varying DEFAULT NULL::character varying, p_data jsonb DEFAULT NULL::jsonb)\n RETURNS analytics_events\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\r\nDECLARE\r\n  v_new_record analytics_events;\r\nBEGIN\r\n  INSERT INTO analytics_events (\r\n    type, user_id, lei, artigo, resultado, \r\n    tem_excecao, tempo_resposta, browser, version, data\r\n  )\r\n  VALUES (\r\n    p_type, p_user_id, p_lei, p_artigo, p_resultado,\r\n    p_tem_excecao, p_tempo_resposta, p_browser, p_version, p_data\r\n  )\r\n  RETURNING * INTO v_new_record;\r\n  \r\n  RETURN v_new_record;\r\nEND;\r\n$function$\n"
      },
      {
        "nome": "verificar_elegibilidade",
        "tipo": "f",
        "retorno": "TABLE(resultado character varying, tipo_crime text, observacoes text, mensagem text, item_alinea_e character varying, excecoes_artigo text)",
        "definicao": "CREATE OR REPLACE FUNCTION public.verificar_elegibilidade(p_codigo_norma character varying, p_artigo character varying, p_paragrafo character varying DEFAULT NULL::character varying, p_inciso character varying DEFAULT NULL::character varying, p_alinea character varying DEFAULT NULL::character varying)\n RETURNS TABLE(resultado character varying, tipo_crime text, observacoes text, mensagem text, item_alinea_e character varying, excecoes_artigo text)\n LANGUAGE plpgsql\nAS $function$\r\nDECLARE\r\n    v_record record;\r\n    v_excecoes_list TEXT;\r\nBEGIN\r\n    -- 1. Buscar o registro mais específico\r\n    -- REGRA CRÍTICA: Se p_paragrafo IS NULL, buscar apenas registros com paragrafo NULL ou 'caput'\r\n    -- Isso garante que buscar \"Art. 122\" sem parágrafo = buscar caput (não qualquer parágrafo)\r\n    SELECT \r\n        t.eh_excecao, t.tipo_crime, t.observacoes, t.item_alinea_e\r\n    INTO v_record\r\n    FROM public.crimes_inelegibilidade t\r\n    WHERE t.codigo = p_codigo_norma \r\n      AND t.artigo = p_artigo\r\n      AND (\r\n          -- Se parágrafo especificado: buscar exatamente esse parágrafo\r\n          (p_paragrafo IS NOT NULL AND t.paragrafo = p_paragrafo)\r\n          OR\r\n          -- Se parágrafo NÃO especificado: buscar o caput (paragrafo NULL)\r\n          (p_paragrafo IS NULL AND t.paragrafo IS NULL)\r\n      )\r\n      AND (p_inciso IS NULL OR t.inciso = p_inciso)\r\n      AND (p_alinea IS NULL OR t.alinea = p_alinea)\r\n    ORDER BY \r\n      (t.paragrafo IS NOT DISTINCT FROM p_paragrafo) DESC,\r\n      (t.inciso IS NOT DISTINCT FROM p_inciso) DESC,\r\n      (t.alinea IS NOT DISTINCT FROM p_alinea) DESC,\r\n      t.eh_excecao ASC \r\n    LIMIT 1;\r\n\r\n    -- 2. Buscar TODAS as exceções para este artigo (para exibir no modal)\r\n    SELECT string_agg(\r\n        CASE \r\n            WHEN t2.paragrafo IS NOT NULL AND t2.paragrafo != '' THEN \r\n                CASE \r\n                    WHEN t2.paragrafo = 'unico' THEN 'Parágrafo único'\r\n                    ELSE 'Parágrafo ' || t2.paragrafo \r\n                END\r\n            WHEN t2.inciso IS NOT NULL THEN 'Inciso ' || t2.inciso \r\n            WHEN t2.alinea IS NOT NULL THEN 'Alínea ' || t2.alinea \r\n            ELSE 'Caput'\r\n        END || COALESCE(' (' || t2.observacoes || ')', ''), \r\n        '; '\r\n    ) INTO v_excecoes_list\r\n    FROM public.crimes_inelegibilidade t2\r\n    WHERE t2.codigo = p_codigo_norma \r\n      AND t2.artigo = p_artigo \r\n      AND t2.eh_excecao = TRUE;\r\n\r\n    -- 3. Se não encontrou registro, retornar NAO_CONSTA\r\n    IF v_record IS NULL THEN\r\n        RETURN QUERY SELECT \r\n            'NAO_CONSTA'::VARCHAR, \r\n            NULL::TEXT, \r\n            NULL::TEXT, \r\n            'Artigo não mapeado como impeditivo.'::TEXT,\r\n            NULL::VARCHAR,\r\n            NULL::TEXT;\r\n        RETURN;\r\n    END IF;\r\n\r\n    -- 4. Retornar resultado estruturado\r\n    RETURN QUERY \r\n    SELECT \r\n      (CASE WHEN v_record.eh_excecao THEN 'ELEGIVEL' ELSE 'INELEGIVEL' END)::VARCHAR, \r\n      v_record.tipo_crime::TEXT, \r\n      v_record.observacoes::TEXT, \r\n      ('Artigo consta na tabela de inelegibilidade (Item ' || COALESCE(v_record.item_alinea_e, '?') || ' da alínea \"e\")')::TEXT,\r\n      v_record.item_alinea_e::VARCHAR,\r\n      v_excecoes_list::TEXT;\r\nEND;\r\n$function$\n"
      }
    ],
    "estatisticas": {
      "totalFuncoes": 6
    }
  },
  "_politicas_rls": {
    "nome": "politicas_rls",
    "tipo": "RLS_POLICIES",
    "politicas": [
      {
        "schema": "public",
        "tabela": "historico_consultas",
        "nome": "Allow anonymous insert",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "INSERT",
        "qual": null,
        "com_check": "true"
      },
      {
        "schema": "public",
        "tabela": "historico_consultas",
        "nome": "Users can read own history",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "SELECT",
        "qual": "(((user_id)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'user_id'::text)) OR ((user_id)::text = current_setting('app.user_id'::text, true)))",
        "com_check": null
      },
      {
        "schema": "public",
        "tabela": "keepalive",
        "nome": "Allow anon insert access",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "INSERT",
        "qual": null,
        "com_check": "true"
      },
      {
        "schema": "public",
        "tabela": "keepalive",
        "nome": "Allow anon update access",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "UPDATE",
        "qual": "true",
        "com_check": null
      },
      {
        "schema": "public",
        "tabela": "keepalive",
        "nome": "Allow public read access",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "SELECT",
        "qual": "true",
        "com_check": null
      },
      {
        "schema": "public",
        "tabela": "keepalive_events",
        "nome": "Allow anon insert access",
        "permissivo": "PERMISSIVE",
        "roles": "{public}",
        "comando": "INSERT",
        "qual": null,
        "com_check": "true"
      }
    ],
    "estatisticas": {
      "totalPoliticas": 6
    }
  },
  "_views": {
    "nome": "views",
    "tipo": "VIEWS",
    "views": [
      {
        "nome": "analytics_result_distribution",
        "definicao": " SELECT resultado,\n    count(*) AS count\n   FROM analytics_events\n  WHERE (((type)::text = 'search'::text) AND (resultado IS NOT NULL))\n  GROUP BY resultado;"
      },
      {
        "nome": "analytics_stats",
        "definicao": " SELECT count(*) AS total_events,\n    count(*) FILTER (WHERE ((type)::text = 'search'::text)) AS total_searches,\n    count(*) FILTER (WHERE ((type)::text = 'error'::text)) AS total_errors,\n    count(*) FILTER (WHERE ((type)::text = 'action'::text)) AS total_actions,\n    count(DISTINCT user_id) AS unique_users,\n    min(\"timestamp\") AS first_event,\n    max(\"timestamp\") AS last_event\n   FROM analytics_events;"
      },
      {
        "nome": "analytics_timeline",
        "definicao": " SELECT date(\"timestamp\") AS date,\n    count(*) AS searches\n   FROM analytics_events\n  WHERE (((type)::text = 'search'::text) AND (\"timestamp\" > (now() - '30 days'::interval)))\n  GROUP BY (date(\"timestamp\"))\n  ORDER BY (date(\"timestamp\")) DESC;"
      },
      {
        "nome": "analytics_top_artigos",
        "definicao": " SELECT lei,\n    artigo,\n    count(*) AS count\n   FROM analytics_events\n  WHERE (((type)::text = 'search'::text) AND (lei IS NOT NULL) AND (artigo IS NOT NULL))\n  GROUP BY lei, artigo\n  ORDER BY (count(*)) DESC\n LIMIT 20;"
      }
    ],
    "estatisticas": {
      "totalViews": 4
    }
  },
  "_sequencias": {
    "nome": "sequencias",
    "tipo": "SEQUENCES",
    "sequencias": [
      {
        "nome": "analytics_events_id_seq",
        "tipo": "bigint",
        "valorInicial": "1",
        "valorMinimo": "1",
        "valorMaximo": "9223372036854775807",
        "incremento": "1"
      },
      {
        "nome": "crimes_inelegibilidade_id_seq",
        "tipo": "integer",
        "valorInicial": "1",
        "valorMinimo": "1",
        "valorMaximo": "2147483647",
        "incremento": "1"
      },
      {
        "nome": "historico_consultas_id_seq",
        "tipo": "bigint",
        "valorInicial": "1",
        "valorMinimo": "1",
        "valorMaximo": "9223372036854775807",
        "incremento": "1"
      },
      {
        "nome": "keepalive_events_id_seq",
        "tipo": "bigint",
        "valorInicial": "1",
        "valorMinimo": "1",
        "valorMaximo": "9223372036854775807",
        "incremento": "1"
      }
    ],
    "estatisticas": {
      "totalSequencias": 4
    }
  }
}